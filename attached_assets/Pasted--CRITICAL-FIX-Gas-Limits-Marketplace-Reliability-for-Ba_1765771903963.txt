## CRITICAL FIX: Gas Limits & Marketplace Reliability for BasedAI Network

The BasedAI network has gas estimation issues that cause transactions to fail with "exceeds block gas limit". This update adds explicit gas limits to all contract interactions.

---

### STEP 1: Update `client/src/hooks/useMarketplace.ts`

Find each `writeContract` call and add the `gas` parameter:

**1.1 - approveMarketplace function (around line 339-345):**
writeContract({
  address: NFT_CONTRACT as `0x${string}`,
  abi: NFT_ABI,
  functionName: 'setApprovalForAll',
  args: [MARKETPLACE_CONTRACT as `0x${string}`, true],
  chainId: CHAIN_ID,
  gas: BigInt(200000),
});**1.2 - listNFT function (around line 370-376):**
writeContract({
  address: MARKETPLACE_CONTRACT as `0x${string}`,
  abi: MARKETPLACE_ABI,
  functionName: 'listNFT',
  args: [BigInt(tokenId), priceWei],
  chainId: CHAIN_ID,
  gas: BigInt(500000),
});**1.3 - delistNFT function (around line 390-396):**
writeContract({
  address: MARKETPLACE_CONTRACT as `0x${string}`,
  abi: MARKETPLACE_ABI,
  functionName: 'delistNFT',
  args: [BigInt(tokenId)],
  chainId: CHAIN_ID,
  gas: BigInt(300000),
});**1.4 - buyNFT function (around line 412-419):**
writeContract({
  address: MARKETPLACE_CONTRACT as `0x${string}`,
  abi: MARKETPLACE_ABI,
  functionName: 'buyNFT',
  args: [BigInt(tokenId)],
  value: priceWei,
  chainId: CHAIN_ID,
  gas: BigInt(500000),
});**1.5 - makeOffer function (around line 435-442):**
writeContract({
  address: MARKETPLACE_CONTRACT as `0x${string}`,
  abi: MARKETPLACE_ABI,
  functionName: 'makeOffer',
  args: [BigInt(tokenId), BigInt(expirationDays)],
  value: offerWei,
  chainId: CHAIN_ID,
  gas: BigInt(300000),
});**1.6 - cancelOffer function (around line 450-456):**
writeContract({
  address: MARKETPLACE_CONTRACT as `0x${string}`,
  abi: MARKETPLACE_ABI,
  functionName: 'cancelOffer',
  args: [BigInt(tokenId)],
  chainId: CHAIN_ID,
  gas: BigInt(200000),
});**1.7 - acceptOffer function (around line 464-470):**
writeContract({
  address: MARKETPLACE_CONTRACT as `0x${string}`,
  abi: MARKETPLACE_ABI,
  functionName: 'acceptOffer',
  args: [BigInt(tokenId), offererAddress as `0x${string}`],
  chainId: CHAIN_ID,
  gas: BigInt(500000),
});---

### STEP 2: Update `client/src/hooks/useMint.ts`

Find the mint writeContract call and add gas limit:

writeContract({
  address: NFT_CONTRACT as `0x${string}`,
  abi: MINT_ABI,
  functionName: 'mint',
  args: [BigInt(quantity)],
  value: totalCost,
  chainId: CHAIN_ID,
  gas: BigInt(500000),
});---

### STEP 3: Update `client/src/hooks/useGovernance.ts`

Add gas limits to all governance writeContract calls:

**3.1 - createProposal:**
writeContract({ 
  address: GOVERNANCE_CONTRACT as `0x${string}`, 
  abi: GOVERNANCE_ABI, 
  functionName: 'createProposal', 
  args: [title, description, category], 
  chainId: CHAIN_ID,
  gas: BigInt(500000),
});**3.2 - vote:**
writeContract({ 
  address: GOVERNANCE_CONTRACT as `0x${string}`, 
  abi: GOVERNANCE_ABI, 
  functionName: 'vote', 
  args: [BigInt(proposalId), support], 
  chainId: CHAIN_ID,
  gas: BigInt(200000),
});**3.3 - finalizeProposal:**
writeContract({ 
  address: GOVERNANCE_CONTRACT as `0x${string}`, 
  abi: GOVERNANCE_ABI, 
  functionName: 'finalizeProposal', 
  args: [BigInt(proposalId)], 
  chainId: CHAIN_ID,
  gas: BigInt(300000),
});**3.4 - cancelProposal:**
writeContract({ 
  address: GOVERNANCE_CONTRACT as `0x${string}`, 
  abi: GOVERNANCE_ABI, 
  functionName: 'cancelProposal', 
  args: [BigInt(proposalId)], 
  chainId: CHAIN_ID,
  gas: BigInt(200000),
});---

### STEP 4: Improve Error Messages

In each hook's error handling, add these specific error messages for better UX:

// Add to error parsing logic:
if (errorMessage.includes('exceeds block gas limit')) {
  return 'Transaction failed - please try again';
} else if (errorMessage.includes('NotTokenOwner')) {
  return 'You do not own this NFT';
} else if (errorMessage.includes('PriceTooLow')) {
  return 'Minimum price is 1 $BASED';
} else if (errorMessage.includes('ListingNotActive')) {
  return 'This NFT is no longer listed';
} else if (errorMessage.includes('InsufficientPayment')) {
  return 'Insufficient $BASED balance';
} else if (errorMessage.includes('NotSeller')) {
  return 'Only the owner can perform this action';
} else if (errorMessage.includes('CannotBuyOwnListing')) {
  return 'You cannot buy your own listing';
}---

### STEP 5: Add Transaction Status Indicator

In the marketplace UI, show when a transaction is pending. In `EscrowMarketplace.tsx` or the relevant component, add:

{marketplace.state.isPending && (
  <div className="fixed bottom-4 right-4 bg-cyan-500/20 border border-cyan-500 rounded-lg p-4 z-50 animate-pulse">
    <p className="text-cyan-400 font-mono text-sm flex items-center gap-2">
      <span className="w-2 h-2 bg-cyan-400 rounded-full animate-ping"></span>
      Confirm in your wallet...
    </p>
  </div>
)}

{marketplace.state.isConfirming && (
  <div className="fixed bottom-4 right-4 bg-amber-500/20 border border-amber-500 rounded-lg p-4 z-50 animate-pulse">
    <p className="text-amber-400 font-mono text-sm flex items-center gap-2">
      <span className="w-2 h-2 bg-amber-400 rounded-full animate-ping"></span>
      Transaction confirming...
    </p>
  </div>
)}---

### Summary of Changes:
| File | Change |
|------|--------|
| useMarketplace.ts | Add `gas: BigInt(X)` to all 7 writeContract calls |
| useMint.ts | Add `gas: BigInt(500000)` to mint writeContract |
| useGovernance.ts | Add `gas: BigInt(X)` to all 4 writeContract calls |
| Error handling | Add specific error messages for contract reverts |
| UI | Add transaction pending indicators |

This fixes the "Transaction failed" errors caused by BasedAI network gas estimation issues.