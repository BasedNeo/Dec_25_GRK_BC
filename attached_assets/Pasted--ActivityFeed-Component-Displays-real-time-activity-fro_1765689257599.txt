/**
 * ActivityFeed Component
 * 
 * Displays real-time activity from the blockchain:
 * - Mints, Sales, Listings, Transfers
 * - Auto-refreshes every 30 seconds
 * - Links to block explorer
 */

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Skeleton } from '@/components/ui/skeleton';
import { 
  RefreshCw, 
  ExternalLink, 
  Activity as ActivityIcon, 
  TrendingUp,
  Zap,
  Filter
} from 'lucide-react';
import { 
  useActivityFeed, 
  Activity, 
  ActivityType,
  getActivityDisplay, 
  formatTimeAgo 
} from '@/hooks/useActivityFeed';
import { BLOCK_EXPLORER } from '@/lib/constants';

interface ActivityFeedProps {
  limit?: number;
  showStats?: boolean;
  compact?: boolean;
  title?: string;
}

export function ActivityFeed({ 
  limit = 20, 
  showStats = true, 
  compact = false,
  title = "LIVE ACTIVITY"
}: ActivityFeedProps) {
  const { activities, isLoading, error, stats, refresh, lastBlock } = useActivityFeed({ limit });
  const [filterType, setFilterType] = useState<ActivityType | 'all'>('all');
  const [isRefreshing, setIsRefreshing] = useState(false);

  const handleRefresh = async () => {
    setIsRefreshing(true);
    await refresh();
    setTimeout(() => setIsRefreshing(false), 500);
  };

  const filteredActivities = filterType === 'all' 
    ? activities 
    : activities.filter(a => a.type === filterType);

  return (
    <section className="py-8">
      <div className="max-w-4xl mx-auto px-4">
        
        {/* Header */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-primary/10 rounded-lg">
              <ActivityIcon className="w-5 h-5 text-primary" />
            </div>
            <div>
              <h2 className="text-2xl font-black text-white font-orbitron">{title}</h2>
              <p className="text-xs text-muted-foreground font-mono">
                Block #{lastBlock.toLocaleString()} â€¢ Auto-refreshes every 30s
              </p>
            </div>
          </div>
          
          <Button 
            variant="outline" 
            size="sm" 
            onClick={handleRefresh}
            disabled={isRefreshing}
            className="border-white/10 text-muted-foreground hover:text-white"
          >
            <RefreshCw className={`w-4 h-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
        </div>

        {/* Stats */}
        {showStats && !compact && (
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <StatCard label="Mints" value={stats.totalMints} icon="ðŸŽ¨" color="text-green-400" />
            <StatCard label="Sales" value={stats.totalSales} icon="ðŸ’°" color="text-yellow-400" />
            <StatCard label="Listings" value={stats.totalListings} icon="ðŸ“‹" color="text-cyan-400" />
            <StatCard label="Transfers" value={stats.totalTransfers} icon="ðŸ”„" color="text-blue-400" />
            <StatCard label="Volume" value={`${stats.totalVolume.toLocaleString()}`} suffix="$BASED" icon="ðŸ“ˆ" color="text-purple-400" />
          </div>
        )}

        {/* Filter Tabs */}
        <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
          {(['all', 'mint', 'sale', 'list', 'transfer'] as const).map((type) => (
            <Badge
              key={type}
              variant="outline"
              className={`cursor-pointer capitalize whitespace-nowrap transition-all ${
                filterType === type 
                  ? 'bg-primary/20 text-primary border-primary' 
                  : 'text-muted-foreground hover:text-white border-white/10'
              }`}
              onClick={() => setFilterType(type)}
            >
              {type === 'all' ? 'ðŸ”¥ All' : getActivityDisplay(type).emoji} {type}
            </Badge>
          ))}
        </div>

        {/* Activity List */}
        <Card className="bg-black/40 border-white/10 overflow-hidden">
          {isLoading ? (
            <div className="p-4 space-y-3">
              {Array.from({ length: 5 }).map((_, i) => (
                <ActivitySkeleton key={i} />
              ))}
            </div>
          ) : error ? (
            <div className="p-8 text-center">
              <p className="text-red-400 mb-4">Failed to load activity</p>
              <Button variant="outline" onClick={refresh}>Try Again</Button>
            </div>
          ) : filteredActivities.length === 0 ? (
            <div className="p-8 text-center">
              <ActivityIcon className="w-12 h-12 text-muted-foreground mx-auto mb-4" />
              <p className="text-muted-foreground">No activity yet</p>
              <p className="text-xs text-muted-foreground/50 mt-2">
                Activity will appear here when NFTs are minted, listed, or sold
              </p>
            </div>
          ) : (
            <AnimatePresence mode="popLayout">
              {filteredActivities.map((activity, index) => (
                <motion.div
                  key={activity.id}
                  initial={{ opacity: 0, x: -20 }}
                  animate={{ opacity: 1, x: 0 }}
                  exit={{ opacity: 0, x: 20 }}
                  transition={{ delay: index * 0.05 }}
                >
                  <ActivityRow activity={activity} compact={compact} />
                </motion.div>
              ))}
            </AnimatePresence>
          )}
        </Card>
      </div>
    </section>
  );
}

function StatCard({ label, value, icon, color, suffix }: { label: string; value: number | string; icon: string; color: string; suffix?: string }) {
  return (
    <Card className="bg-white/5 border-white/10 p-4">
      <div className="flex items-center gap-2 mb-1">
        <span>{icon}</span>
        <span className="text-xs text-muted-foreground font-mono uppercase">{label}</span>
      </div>
      <div className={`text-2xl font-bold font-orbitron ${color}`}>
        {value}
        {suffix && <span className="text-sm ml-1 text-muted-foreground">{suffix}</span>}
      </div>
    </Card>
  );
}

function ActivityRow({ activity, compact }: { activity: Activity; compact: boolean }) {
  const display = getActivityDisplay(activity.type);
  const shortenAddress = (addr: string) => 
    addr.length > 20 ? `${addr.slice(0, 6)}...${addr.slice(-4)}` : addr;

  return (
    <div className="flex items-center justify-between p-4 border-b border-white/5 hover:bg-white/5 transition-colors group">
      <div className="flex items-center gap-4">
        <div className="text-2xl">{display.emoji}</div>
        <div>
          <div className="flex items-center gap-2">
            <span className={`font-bold ${display.color}`}>{display.label}</span>
            <Badge variant="outline" className="text-xs border-white/20">#{activity.tokenId}</Badge>
          </div>
          {!compact && (
            <div className="text-xs text-muted-foreground mt-1 font-mono">
              {activity.type === 'mint' ? (
                <span>Minted by <span className="text-white">{shortenAddress(activity.to)}</span></span>
              ) : activity.type === 'sale' ? (
                <span><span className="text-white">{shortenAddress(activity.from)}</span> â†’ <span className="text-white">{shortenAddress(activity.to)}</span></span>
              ) : activity.type === 'list' ? (
                <span>Listed by <span className="text-white">{shortenAddress(activity.from)}</span></span>
              ) : (
                <span><span className="text-white">{shortenAddress(activity.from)}</span> â†’ <span className="text-white">{shortenAddress(activity.to)}</span></span>
              )}
            </div>
          )}
        </div>
      </div>
      <div className="flex items-center gap-4">
        {activity.price && (
          <div className="text-right">
            <div className="text-sm font-bold text-white font-mono">{Number(activity.price).toLocaleString()}</div>
            <div className="text-xs text-primary">$BASED</div>
          </div>
        )}
        <div className="text-right">
          <div className="text-xs text-muted-foreground">{formatTimeAgo(activity.timestamp)}</div>
          <a
            href={`${BLOCK_EXPLORER}/tx/${activity.txHash}`}
            target="_blank"
            rel="noopener noreferrer"
            className="text-xs text-primary hover:underline flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity"
          >
            View <ExternalLink size={10} />
          </a>
        </div>
      </div>
    </div>
  );
}

function ActivitySkeleton() {
  return (
    <div className="flex items-center justify-between p-4 border-b border-white/5">
      <div className="flex items-center gap-4">
        <Skeleton className="w-10 h-10 rounded-full" />
        <div>
          <Skeleton className="h-4 w-24 mb-2" />
          <Skeleton className="h-3 w-32" />
        </div>
      </div>
      <div className="text-right">
        <Skeleton className="h-4 w-16 mb-2" />
        <Skeleton className="h-3 w-12" />
      </div>
    </div>
  );
}

export default ActivityFeed;