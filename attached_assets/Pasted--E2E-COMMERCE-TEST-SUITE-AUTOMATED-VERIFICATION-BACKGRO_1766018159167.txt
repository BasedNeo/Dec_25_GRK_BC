=== E2E COMMERCE TEST SUITE + AUTOMATED VERIFICATION ===

BACKGROUND: Manual testing is error-prone and time-consuming. Need automated test suite for critical commerce flows.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PART 1: CREATE MANUAL TEST PROTOCOL (REQUIRED BEFORE EACH DEPLOY)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE: tests/MANUAL_TEST_PROTOCOL.md

# ğŸ§ª Manual Commerce Test Protocol

Run BEFORE every production deployment. Check ALL boxes.

## Prerequisites
- [ ] Development server running (`npm run dev`)
- [ ] Test wallet with $BASED tokens
- [ ] Clean browser (clear localStorage, cookies)
- [ ] Desktop + mobile device ready

---

## TEST 1: MINT FLOW (CRITICAL)

### Setup
- Navigate to /mint
- Connect test wallet
- Verify balance shown correctly

### Test Cases
- [ ] **T1.1** - Display shows correct mint price (69,420 $BASED)
- [ ] **T1.2** - Display shows remaining supply accurately
- [ ] **T1.3** - Click "Mint 1 NFT" â†’ Wallet prompts for approval
- [ ] **T1.4** - Confirm transaction â†’ Shows "Minting..." status
- [ ] **T1.5** - Wait for confirmation â†’ Shows success message
- [ ] **T1.6** - Navigate to Portfolio â†’ New NFT appears

### Expected Behavior
âœ… Mint price matches 69,420 $BASED
âœ… Transaction completes within 60 seconds
âœ… NFT ownership verified on-chain
âœ… Balance updates correctly after mint

### If Failed
âŒ Check gas limit set to 8,000,000
âŒ Verify NFT_CONTRACT address in constants.ts
âŒ Check RPC endpoint health

---

## TEST 2: MARKETPLACE LISTING (CRITICAL)

### Setup
- Navigate to Portfolio
- Select an owned, unlisted NFT
- Click "List for Sale"

### Test Cases
- [ ] **T2.1** - If not approved â†’ Shows "Approve Marketplace" button
- [ ] **T2.2** - Click approve â†’ Wallet prompts for approval
- [ ] **T2.3** - Approval confirms â†’ Button changes to "List NFT"
- [ ] **T2.4** - Enter price (e.g., 100,000 $BASED)
- [ ] **T2.5** - Validation: Price < 1 â†’ Shows error
- [ ] **T2.6** - Validation: Already listed â†’ Shows error
- [ ] **T2.7** - Valid price â†’ Transaction submits
- [ ] **T2.8** - Transaction confirms â†’ NFT appears in Market with "Listed" badge

### Expected Behavior
âœ… Two-step process: Approve â†’ List
âœ… NFT stays in wallet (doesn't transfer to marketplace)
âœ… Listing appears in market within 30 seconds
âœ… Price displays correctly

### If Failed
âŒ Check MARKETPLACE_CONTRACT address
âŒ Verify approval check logic in useMarketplace.ts
âŒ Check event logs from marketplace contract

---

## TEST 3: MARKETPLACE PURCHASE (CRITICAL)

### Setup
- Navigate to Market
- Find a listed NFT (not owned by you)
- Verify you have sufficient balance

### Test Cases
- [ ] **T3.1** - Click "Buy Now" â†’ Shows purchase confirmation
- [ ] **T3.2** - Confirm â†’ Wallet prompts for transaction
- [ ] **T3.3** - Verify exact price + platform fee shown
- [ ] **T3.4** - Transaction submits â†’ Shows "Buying..." status
- [ ] **T3.5** - Transaction confirms â†’ NFT removed from market
- [ ] **T3.6** - NFT appears in your Portfolio
- [ ] **T3.7** - Seller's balance increases correctly
- [ ] **T3.8** - Platform fee sent to correct address

### Expected Behavior
âœ… Buyer pays exact listed price
âœ… Ownership transfers immediately
âœ… Listing removed from market
âœ… Balances update correctly

### If Failed
âŒ Check gas limit (400,000 for buy)
âŒ Verify platform fee percentage (1%)
âŒ Check royalty distribution

---

## TEST 4: V3 OFFER SYSTEM (CRITICAL)

### Setup
- Navigate to Market or Portfolio
- Select an unlisted NFT (or listed NFT you don't own)
- Click "Make Offer"

### Test Cases
- [ ] **T4.1** - Enter offer amount (e.g., 80,000 $BASED)
- [ ] **T4.2** - Enter optional message (< 280 chars)
- [ ] **T4.3** - Click "Submit Offer" â†’ Wallet prompts for SIGNATURE (NOT transaction)
- [ ] **T4.4** - Sign message â†’ No gas cost
- [ ] **T4.5** - Offer created â†’ Shows in "My Offers" panel
- [ ] **T4.6** - Switch to NFT owner wallet
- [ ] **T4.7** - See pending offer with buyer's message
- [ ] **T4.8** - Click "Accept" â†’ Transaction submits
- [ ] **T4.9** - Switch back to buyer wallet
- [ ] **T4.10** - See "Complete Purchase" button
- [ ] **T4.11** - Click complete â†’ Transaction submits with offer amount
- [ ] **T4.12** - NFT transfers to buyer

### Expected Behavior
âœ… Offer creation is FREE (signature only)
âœ… Offer stored in localStorage
âœ… Seller can accept (pays gas)
âœ… Buyer completes (pays price + gas)
âœ… NFT transfers correctly

### If Failed
âŒ Check EIP-712 signature domain
âŒ Verify MARKETPLACE_V3_CONTRACT address
âŒ Check localStorage offer storage
âŒ Verify nonce tracking

---

## TEST 5: CUSTOM NAME SYSTEM (HIGH PRIORITY)

### Setup
- Navigate to Stats page
- Connect wallet

### Test Cases
- [ ] **T5.1** - If no name set â†’ Shows "Set Name" button
- [ ] **T5.2** - Click â†’ Shows name input modal
- [ ] **T5.3** - Enter 1 character â†’ Shows error "Must be 2+ chars"
- [ ] **T5.4** - Enter 17 characters â†’ Auto-truncated to 16
- [ ] **T5.5** - Enter special chars (!@#$) â†’ Auto-removed
- [ ] **T5.6** - Enter profanity â†’ Shows "inappropriate content" error
- [ ] **T5.7** - Enter valid name "TestUser" â†’ Green checkmark
- [ ] **T5.8** - Click Save â†’ Shows disclaimer popup
- [ ] **T5.9** - Click "I Understand" â†’ Name saves successfully
- [ ] **T5.10** - Name displays as "TestUser#ABC" (with wallet suffix)
- [ ] **T5.11** - Try duplicate name â†’ Shows "already taken"

### Expected Behavior
âœ… Real-time availability check
âœ… Character validation enforced
âœ… Profanity filter works
âœ… Disclaimer shown on first save
âœ… Name persists across sessions

### If Failed
âŒ Run: npm run db:push (create guardian_profiles table)
âŒ Check profanityFilter.ts
âŒ Verify API endpoint /api/profile/name

---

## TEST 6: GAME (MEDIUM PRIORITY)

### Setup
- Navigate to /game
- Test with and without NFT ownership

### Test Cases
- [ ] **T6.1** - Game loads within 5 seconds
- [ ] **T6.2** - Without NFT â†’ 3 lives, 1x score multiplier
- [ ] **T6.3** - With NFT â†’ 4 lives, 1.5x score multiplier
- [ ] **T6.4** - Controls responsive (arrow keys / touch)
- [ ] **T6.5** - Enemies spawn correctly
- [ ] **T6.6** - Shooting works (bullets fire)
- [ ] **T6.7** - Collision detection works
- [ ] **T6.8** - Game Over â†’ Shows final score
- [ ] **T6.9** - Play Again â†’ Resets properly
- [ ] **T6.10** - Leaderboard updates after game

### Expected Behavior
âœ… Smooth 60fps gameplay
âœ… NFT holders get perks
âœ… Scores saved to database
âœ… No memory leaks after multiple plays

### If Failed
âŒ Check useGameAccess.ts (NFT gating)
âŒ Verify gameEngine.ts loop cleanup
âŒ Check game score API endpoint

---

## TEST 7: MULTI-LANGUAGE (MEDIUM PRIORITY)

### Setup
- Open language selector (bottom-right)

### Test Cases
- [ ] **T7.1** - Switch to Spanish â†’ Nav menu translates
- [ ] **T7.2** - Switch to Chinese â†’ UI elements translate
- [ ] **T7.3** - Go to Marketplace â†’ Buttons translated
- [ ] **T7.4** - Go to Stats â†’ Labels translated
- [ ] **T7.5** - No "undefined" or "[object Object]" displayed
- [ ] **T7.6** - Switch back to English â†’ Everything reverts

### Expected Behavior
âœ… All visible text translates
âœ… No broken keys
âœ… Layout doesn't break with longer text
âœ… Language persists on refresh

### If Failed
âŒ Check locale files (en.json, es.json, etc.)
âŒ Verify all t('key') calls
âŒ Check i18n initialization

---

## TEST 8: MOBILE RESPONSIVENESS (MEDIUM PRIORITY)

### Setup
- Open app on mobile device OR Chrome DevTools mobile view
- Test with iPhone 12 Pro and Samsung Galaxy S21 sizes

### Test Cases
- [ ] **T8.1** - Homepage loads correctly
- [ ] **T8.2** - Navigation menu accessible (hamburger works)
- [ ] **T8.3** - Marketplace cards responsive
- [ ] **T8.4** - NFT images load and display correctly
- [ ] **T8.5** - Buttons are touch-friendly (min 44px height)
- [ ] **T8.6** - Wallet connect modal appears correctly
- [ ] **T8.7** - Forms are usable (no zoom-in on input focus)
- [ ] **T8.8** - Game playable with touch controls

### Expected Behavior
âœ… No horizontal scroll
âœ… Touch targets large enough
âœ… Text readable without zoom
âœ… Wallet connectivity works

### If Failed
âŒ Check Tailwind breakpoints (sm:, md:, lg:)
âŒ Verify touch-action CSS
âŒ Check viewport meta tag

---

## TEST 9: ERROR HANDLING (HIGH PRIORITY)

### Setup
- Simulate error conditions

### Test Cases
- [ ] **T9.1** - Disconnect wallet mid-transaction â†’ Shows error, doesn't crash
- [ ] **T9.2** - Insufficient balance â†’ Clear error message
- [ ] **T9.3** - Network timeout â†’ Retry option shown
- [ ] **T9.4** - Invalid input â†’ Validation message displays
- [ ] **T9.5** - Browser console â†’ No uncaught errors
- [ ] **T9.6** - Switch networks â†’ Banner prompts to switch back
- [ ] **T9.7** - Reject transaction â†’ Returns to previous state

### Expected Behavior
âœ… No app crashes
âœ… Clear error messages
âœ… Graceful degradation
âœ… User can recover from errors

### If Failed
âŒ Check ErrorBoundary wrappers
âŒ Verify error handling in hooks
âŒ Check parseContractError utility

---

## TEST 10: PERFORMANCE & MEMORY (HIGH PRIORITY)

### Setup
- Open Chrome DevTools â†’ Performance tab
- Open browser console

### Test Cases
- [ ] **T10.1** - Run: `timers()` â†’ Active timers < 20
- [ ] **T10.2** - Run: `memReport()` â†’ Memory < 200MB
- [ ] **T10.3** - Navigate between pages 10 times â†’ Memory stable
- [ ] **T10.4** - Play game 3 times â†’ No memory spike
- [ ] **T10.5** - Leave app open 5 minutes â†’ No memory leak
- [ ] **T10.6** - Check console â†’ No repeated error logs
- [ ] **T10.7** - Check network tab â†’ No failed requests looping

### Expected Behavior
âœ… Memory usage stable over time
âœ… Timer count stays low
âœ… No infinite loops or leaks
âœ… Efficient resource usage

### If Failed
âŒ Check useInterval cleanup
âŒ Verify useEffect return functions
âŒ Check event listener cleanup

---

## FINAL SIGN-OFF

### Pre-Deploy Checklist
- [ ] All 10 test suites passed
- [ ] No console errors during testing
- [ ] Core integrity verified: `npm run core:verify`
- [ ] Database verified: `npm run db:verify`
- [ ] Backups created: `npm run core:backup`
- [ ] Build succeeds: `npm run build`
- [ ] Production build tested locally

### Tester Information
- **Date**: _______________
- **Tester Name**: _______________
- **Environment**: Dev / Staging / Production
- **Browser**: _______________
- **OS**: _______________

### Notes
_Any issues, warnings, or observations:_

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

**APPROVAL**
- [ ] I certify all tests have passed
- [ ] I approve deployment to production

Signature: _______________ Date: _______________

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PART 2: AUTOMATED SMOKE TESTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE: tests/smoke-tests.ts

/**
 * Smoke Tests - Quick automated checks before deployment
 * Run: tsx tests/smoke-tests.ts
 */

import { ethers } from 'ethers';
import fetch from 'node-fetch';

const RPC_URL = 'https://mainnet.basedaibridge.com/rpc/';
const NFT_CONTRACT = '0xaE51dc5fD1499A129f8654963560f9340773ad59';
const MARKETPLACE_CONTRACT = '0x2836f07Ed31a6DEc09E0d62Fb15D7c6c6Ddb139c';
const MARKETPLACE_V3_CONTRACT = '0x2a3f9D8b844c2dB2F42095B49817c0D6991514f3';
const API_BASE = process.env.API_URL || 'http://localhost:5000';

interface TestResult {
  name: string;
  passed: boolean;
  duration: number;
  error?: string;
}

const results: TestResult[] = [];

async function test(name: string, fn: () => Promise<void>) {
  const start = Date.now();
  try {
    await fn();
    results.push({ name, passed: true, duration: Date.now() - start });
    console.log(`âœ… ${name} (${Date.now() - start}ms)`);
  } catch (error: any) {
    results.push({ name, passed: false, duration: Date.now() - start, error: error.message });
    console.error(`âŒ ${name}: ${error.message}`);
  }
}

async function main() {
  console.log('\nğŸ§ª Running Smoke Tests...\n');

  // Test 1: RPC Connectivity
  await test('RPC Endpoint Reachable', async () => {
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const blockNumber = await provider.getBlockNumber();
    if (blockNumber === 0) throw new Error('Block number is 0');
  });

  // Test 2: NFT Contract Deployed
  await test('NFT Contract Exists', async () => {
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const code = await provider.getCode(NFT_CONTRACT);
    if (code === '0x') throw new Error('Contract not deployed');
  });

  // Test 3: Marketplace Contract Deployed
  await test('Marketplace V2 Exists', async () => {
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const code = await provider.getCode(MARKETPLACE_CONTRACT);
    if (code === '0x') throw new Error('Contract not deployed');
  });

  // Test 4: Marketplace V3 Contract Deployed
  await test('Marketplace V3 Exists', async () => {
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const code = await provider.getCode(MARKETPLACE_V3_CONTRACT);
    if (code === '0x') throw new Error('Contract not deployed');
  });

  // Test 5: Total Supply Readable
  await test('NFT Total Supply Readable', async () => {
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const nft = new ethers.Contract(
      NFT_CONTRACT,
      ['function totalSupply() view returns (uint256)'],
      provider
    );
    const supply = await nft.totalSupply();
    if (supply < 0) throw new Error('Invalid supply');
  });

  // Test 6: Mint Price Correct
  await test('Mint Price is 69,420 $BASED', async () => {
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const nft = new ethers.Contract(
      NFT_CONTRACT,
      ['function MINT_PRICE() view returns (uint256)'],
      provider
    );
    const price = await nft.MINT_PRICE();
    const expected = ethers.parseEther('69420');
    if (price !== expected) {
      throw new Error(`Mint price is ${ethers.formatEther(price)}, expected 69420`);
    }
  });

  // Test 7: API Health Check
  await test('API Health Endpoint', async () => {
    const response = await fetch(`${API_BASE}/api/health`);
    if (response.status !== 200) throw new Error(`Status ${response.status}`);
  });

  // Test 8: Profile API Works
  await test('Profile API Responds', async () => {
    const response = await fetch(`${API_BASE}/api/profile/check-name/test123`);
    if (response.status !== 200) throw new Error(`Status ${response.status}`);
    const data = await response.json();
    if (!('available' in data)) throw new Error('Invalid response format');
  });

  // Test 9: Rate Limiting Active
  await test('Rate Limiting Active', async () => {
    // Make 105 rapid requests (should hit limit at 100)
    const promises = [];
    for (let i = 0; i < 105; i++) {
      promises.push(fetch(`${API_BASE}/api/health`));
    }
    const responses = await Promise.all(promises);
    const rateLimited = responses.filter(r => r.status === 429);
    if (rateLimited.length === 0) {
      throw new Error('Rate limiting not working');
    }
  });

  // Test 10: Database Connection
  await test('Database Accessible', async () => {
    const response = await fetch(`${API_BASE}/api/profile/check-name/smoketest${Date.now()}`);
    if (response.status !== 200) throw new Error('DB connection failed');
  });

  // Summary
  console.log('\n' + '='.repeat(50));
  console.log('SMOKE TEST SUMMARY');
  console.log('='.repeat(50));
  
  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;
  const totalTime = results.reduce((sum, r) => sum + r.duration, 0);
  
  console.log(`\nTotal: ${results.length} tests`);
  console.log(`âœ… Passed: ${passed}`);
  console.log(`âŒ Failed: ${failed}`);
  console.log(`â±ï¸  Duration: ${totalTime}ms`);
  
  if (failed > 0) {
    console.log('\nâŒ FAILED TESTS:');
    results.filter(r => !r.passed).forEach(r => {
      console.log(`  - ${r.name}: ${r.error}`);
    });
    process.exit(1);
  }
  
  console.log('\nâœ… All smoke tests passed!\n');
  process.exit(0);
}

main().catch(error => {
  console.error('\nâŒ Smoke tests failed:', error);
  process.exit(1);
});

ADD TO package.json:
"scripts": {
  "test:smoke": "tsx tests/smoke-tests.ts",
  "pre-deploy": "npm run core:verify && npm run test:smoke && npm run build"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERIFICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Run smoke tests:
   npm run test:smoke
   # Should pass all 10 tests in < 5 seconds

2. Run manual test protocol:
   # Follow MANUAL_TEST_PROTOCOL.md
   # Check all boxes
   # Document any failures

3. Verify pre-deploy script:
   npm run pre-deploy
   # Should run: core:verify â†’ test:smoke â†’ build
   # Should complete successfully

CHECKLIST:
â–¡ MANUAL_TEST_PROTOCOL.md created
â–¡ smoke-tests.ts created
â–¡ All 10 smoke tests pass
â–¡ Manual protocol documented
â–¡ pre-deploy script works
â–¡ Test results logged
â–¡ Ready for production deployment