import { invalidateFeatureFlagsCache } from '@/lib/featureFlags';

const [featureFlags, setFeatureFlags] = useState<any[]>([]);
const [updatingFlag, setUpdatingFlag] = useState<string | null>(null);

const fetchFeatureFlags = async () => {
  try {
    const res = await fetch('/api/feature-flags');
    const data = await res.json();
    setFeatureFlags(data);
  } catch (error) {
    console.error('Failed to fetch feature flags:', error);
  }
};

const toggleFeatureFlag = async (key: string, currentValue: boolean) => {
  if (!address) return;
  
  setUpdatingFlag(key);
  addLog(`Updating ${key} to ${!currentValue}...`);

  try {
    const res = await fetch(`/api/feature-flags/${key}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: !currentValue, walletAddress: address }),
    });

    if (!res.ok) throw new Error('Failed to update');

    invalidateFeatureFlagsCache();
    await fetchFeatureFlags();
    addLog(`✅ ${key} set to ${!currentValue}`);
  } catch (error) {
    addLog(`❌ Failed to update ${key}`);
  } finally {
    setUpdatingFlag(null);
  }
};

useEffect(() => {
  if (isOpen && isAdmin) {
    fetchFeatureFlags();
  }
}, [isOpen, isAdmin]);

// Add this JSX section after the System Health section (around line 450):
<div className="mb-6">
  <h3 className="text-sm font-bold text-white mb-3 flex items-center gap-2">
    <Zap size={16} className="text-yellow-400" />
    Feature Flags (Global)
  </h3>
  <div className="bg-black/40 rounded-lg p-4 space-y-3">
    {featureFlags.map((flag) => (
      <div key={flag.key} className="flex items-center justify-between p-3 bg-white/5 rounded border border-white/10">
        <div className="flex-1">
          <div className="text-white font-bold text-sm">{flag.description}</div>
          <div className="text-xs text-gray-500 font-mono">{flag.key}</div>
        </div>
        <button
          onClick={() => toggleFeatureFlag(flag.key, flag.enabled)}
          disabled={updatingFlag === flag.key}
          className={`
            relative inline-flex h-6 w-11 items-center rounded-full transition-colors
            ${flag.enabled ? 'bg-green-500' : 'bg-gray-600'}
            ${updatingFlag === flag.key ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}
          `}
        >
          <span
            className={`
              inline-block h-4 w-4 transform rounded-full bg-white transition-transform
              ${flag.enabled ? 'translate-x-6' : 'translate-x-1'}
            `}
          />
        </button>
      </div>
    ))}
    
    <div className="bg-yellow-500/10 border border-yellow-500/30 rounded p-3 flex items-start gap-2 mt-4">
      <AlertTriangle className="w-4 h-4 text-yellow-400 flex-shrink-0 mt-0.5" />
      <div className="text-xs text-yellow-200">
        Feature flags affect ALL users immediately. Use to disable features if there's a bug or during maintenance.
      </div>
    </div>
  </div>
</div>